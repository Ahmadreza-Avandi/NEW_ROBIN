# ๐ค ุจูุจูุฏูุง ุฏุณุชุงุฑ ุตูุช ุฑุงุจู

## ๐ ุชุบุฑุงุช ุงุนูุงู ุดุฏู

### 1. โ ูพุงุณุฎโูุง ุทููุงูโุชุฑ ู ฺฉุงููโุชุฑ

#### ุชุบุฑุงุช ุฏุฑ AI Prompt (app/api/voice-assistant/ai/route.ts):

**ูุจู:**
```typescript
max_tokens: 300  // ูพุงุณุฎโูุง ฺฉูุชุงู
```

**ุจุนุฏ:**
```typescript
max_tokens: 800  // ูพุงุณุฎโูุง ุทููุงูโุชุฑ ู ฺฉุงููโุชุฑ
```

#### ุชุบุฑุงุช ุฏุฑ System Message:

**ูุจู:**
```
- ูพุงุณุฎโูุงุช ฺฉูุชุงู ู ููุฏ ุจุงุดุฏ (ุญุฏุงฺฉุซุฑ 2-3 ุฌููู ุจุฑุง ูพุฎุด ุตูุช)
```

**ุจุนุฏ:**
```
- ูพุงุณุฎโูุงุช ฺฉุงูู ู ููุตู ุจุงุดุฏ (4-6 ุฌููู ุง ุจุดุชุฑ)
- ุฌุฒุฆุงุช ู ุชูุถุญุงุช ุจุดุชุฑ ุงุฑุงุฆู ฺฉู
- ุงฺฏุฑ ุฏุงุฏูโุง ุงุฒ ุฏุชุงุจุณ ุฏุงุฑุ ููู ุฌุฒุฆุงุช ุฑุง ุจฺฏู
- ูพุงุณุฎโูุง ุฎู ฺฉูุชุงู ูุฏูุ ุชูุถุญุงุช ฺฉุงู ุจุฏู
```

**ูุชุฌู:**
- โ ูพุงุณุฎโูุง ุญุงูุง 2-3 ุจุฑุงุจุฑ ุทููุงูโุชุฑ ูุณุชูุฏ
- โ ุฌุฒุฆุงุช ุจุดุชุฑ ุงุฑุงุฆู ูโุดูุฏ
- โ ุชูุถุญุงุช ฺฉุงููโุชุฑ ู ููุฏุชุฑ

---

### 2. โ ุจูุจูุฏ ูพุฎุด ุตุฏุง ู ุฌููฺฏุฑ ุงุฒ ุงุฒ ุฏุณุช ุฑูุชู

#### ุงูู) Retry Mechanism ุฏุฑ Frontend

**ุชุงุจุน ุฌุฏุฏ playAudio ุจุง 3 ุชูุงุด:**

```typescript
async function playAudio(text: string, retries = 3): Promise<void> {
  for (let attempt = 1; attempt <= retries; attempt++) {
    try {
      // ุชูุงุด ุจุฑุง ุฏุฑุงูุช ู ูพุฎุด ุตุฏุง
      // ...
    } catch (error) {
      // ุงฺฏุฑ ูุงูููู ุจูุฏุ ุตุจุฑ ฺฉู ู ุฏูุจุงุฑู ุชูุงุด ฺฉู
      if (attempt < retries) {
        await new Promise(resolve => setTimeout(resolve, attempt * 1000));
      }
    }
  }
}
```

**ูฺฺฏโูุง:**
- โ 3 ุชูุงุด ุจุฑุง ุฏุฑุงูุช ุตุฏุง
- โ ุชุงุฎุฑ ุชุตุงุนุฏ ุจู ุชูุงุดโูุง (1s, 2s, 3s)
- โ ูุงฺฏโูุง ุฏูู ุจุฑุง debugging

#### ุจ) ุจูุจูุฏ ุจุงุฑฺฏุฐุงุฑ ุตุฏุง

**ูุจู:**
```typescript
const audio = new Audio(data.audioUrl);
await audio.play();
```

**ุจุนุฏ:**
```typescript
const audio = new Audio();
audio.preload = 'auto';
audio.crossOrigin = 'anonymous';
audio.src = audioSrc;

// ููุชุธุฑ ุจุงุฑฺฏุฐุงุฑ ฺฉุงูู
await new Promise((resolve, reject) => {
  audio.oncanplaythrough = () => resolve();
  audio.onerror = (e) => reject(e);
  audio.load();
});

// ุณูพุณ ูพุฎุด
await audio.play();
```

**ูุฒุงุง:**
- โ ุจุงุฑฺฏุฐุงุฑ ฺฉุงูู ูุจู ุงุฒ ูพุฎุด
- โ ูุฏุฑุช ุจูุชุฑ ุฎุทุงูุง
- โ timeout ุจุฑุง ุฌููฺฏุฑ ุงุฒ hang

#### ุฌ) ุงูุฒุงุด Timeout ุจุฑุง ูุชูโูุง ุทููุงู

**ุฏุฑ TTS API (app/api/voice-assistant/tts/route.ts):**

**ูุจู:**
```typescript
signal: AbortSignal.timeout(30000) // 30 ุซุงูู ุซุงุจุช
```

**ุจุนุฏ:**
```typescript
const timeoutDuration = Math.max(45000, processedText.length * 100);
// ุญุฏุงูู 45 ุซุงูู ุง ุจุดุชุฑ ุจุฑุง ูุชูโูุง ุทููุงู
signal: AbortSignal.timeout(timeoutDuration)
```

**ูุซุงู:**
- ูุชู 100 ฺฉุงุฑุงฺฉุชุฑ โ 45 ุซุงูู
- ูุชู 500 ฺฉุงุฑุงฺฉุชุฑ โ 50 ุซุงูู
- ูุชู 1000 ฺฉุงุฑุงฺฉุชุฑ โ 100 ุซุงูู

#### ุฏ) ุจูุจูุฏ Response Headers

**ุงุถุงูู ุดุฏู:**
```typescript
response.headers.set('Cache-Control', 'no-cache, no-store, must-revalidate');
response.headers.set('X-Audio-Ready', 'true');
```

**ูุฒุงุง:**
- โ ุฌููฺฏุฑ ุงุฒ cache ูุดฺฉูโุฏุงุฑ
- โ ุงุทูุงุนุงุช ุจุดุชุฑ ุจุฑุง debugging

#### ู) ููุงุด ูพุงุณุฎ ูุชู ุฏุฑ ุตูุฑุช ุฎุทุง

**ูุจู:**
```typescript
dispatch({
  type: 'SET_ERROR',
  payload: 'ูพุงุณุฎ ุฏุฑุงูุช ุดุฏ ุงูุง ูพุฎุด ุตุฏุง ูุงูููู ุจูุฏ.'
});
```

**ุจุนุฏ:**
```typescript
// ููุงุด ูพุงู ุฎุทุง ุจุง ุจุฎุด ุงุฒ ูุชู
dispatch({
  type: 'SET_ERROR',
  payload: `ูพุงุณุฎ ุฏุฑุงูุช ุดุฏ: "${responseText.substring(0, 100)}..." ุงูุง ูพุฎุด ุตุฏุง ูุงูููู ุจูุฏ.`
});

// ููุงุด ฺฉุงูู ูพุงุณุฎ ุฏุฑ alert
alert(`ูพุงุณุฎ ุฑุงุจู:\n\n${responseText}`);
```

**ูุฒุงุง:**
- โ ฺฉุงุฑุจุฑ ูพุงุณุฎ ุฑุง ูโุจูุฏ ุญุช ุงฺฏุฑ ุตุฏุง ูพุฎุด ูุดูุฏ
- โ ุชุฌุฑุจู ฺฉุงุฑุจุฑ ุจูุชุฑ

---

## ๐ ููุงุณู ูุจู ู ุจุนุฏ

### ูพุงุณุฎโูุง AI:

| ูฺฺฏ | ูุจู | ุจุนุฏ |
|-------|-----|-----|
| ุทูู ูพุงุณุฎ | 2-3 ุฌููู | 4-6 ุฌููู ุง ุจุดุชุฑ |
| max_tokens | 300 | 800 |
| ุฌุฒุฆุงุช | ูุญุฏูุฏ | ฺฉุงูู ู ููุตู |
| ุชูุถุญุงุช | ุฎูุงุตู | ฺฉุงูู |

### ูพุฎุด ุตุฏุง:

| ูฺฺฏ | ูุจู | ุจุนุฏ |
|-------|-----|-----|
| ุชูุงุด ูุฌุฏุฏ | โ ุฎุฑ | โ 3 ุจุงุฑ |
| ุจุงุฑฺฏุฐุงุฑ | ูุณุชูู | ุจุง preload ู canplaythrough |
| timeout | 30s ุซุงุจุช | ูพูุง (45s-100s+) |
| ูุฏุฑุช ุฎุทุง | ุณุงุฏู | ูพุดุฑูุชู ุจุง fallback |
| ููุงุด ูุชู | โ ุฎุฑ | โ ุจูู |

---

## ๐งช ุชุณุช ุชุบุฑุงุช

### 1. ุชุณุช ูพุงุณุฎโูุง ุทููุงู:

```bash
# ุณูุงู ุณุงุฏู
"ฺูุฏ ูุดุชุฑ ุฏุงุฑูุ"

# ุงูุชุธุงุฑ: ูพุงุณุฎ 4-6 ุฌูููโุง ุจุง ุฌุฒุฆุงุช
```

### 2. ุชุณุช ูพุฎุด ุตุฏุง:

```bash
# ุชุณุช ุจุง ูุชู ฺฉูุชุงู
"ุณูุงู"

# ุชุณุช ุจุง ูุชู ุทููุงู (500+ ฺฉุงุฑุงฺฉุชุฑ)
"ูุทูุงู ุชูุถุญุงุช ฺฉุงูู ุฏุฑุจุงุฑู ูุดุชุฑุงูุ ูุฑูุดุ ู ูุถุนุช ฺฉู ุณุณุชู ุจุฏู"
```

### 3. ุชุณุช Retry:

```bash
# ูุทุน ุงูุชุฑูุช ูููุช
# ุงูุชุธุงุฑ: 3 ุชูุงุด ุจุง ุชุงุฎุฑ 1s, 2s, 3s
```

### 4. ูุดุงูุฏู ูุงฺฏโูุง:

```javascript
// ุฏุฑ Console ูุฑูุฑฺฏุฑ:
๐ต Attempt 1/3 - Requesting TTS for text length: 245
โ TTS Response received: { audioUrl: "...", requestId: "..." }
๐ Loading audio from: https://...
โ Audio loaded and ready to play
โถ๏ธ Starting audio playback...
โ Audio playback completed
```

---

## ๐ง ุชูุธูุงุช ูุงุจู ุชุบุฑ

### ุฏุฑ .env:

```bash
# ุงูุฒุงุด timeout ุจุฑุง AI
RABIN_VOICE_OPENROUTER_MODEL=anthropic/claude-3-haiku

# ุงูุฒุงุด timeout ุจุฑุง TTS
RABIN_VOICE_TTS_API_URL=https://api.ahmadreza-avandi.ir/text-to-speech
```

### ุฏุฑ ฺฉุฏ:

#### ุชุนุฏุงุฏ ุชูุงุดโูุง retry:
```typescript
// app/[tenant_key]/dashboard/voice-assistant/page.tsx
await playAudio(responseText, 3); // ุชุบุฑ ุจู 5 ุจุฑุง ุชูุงุด ุจุดุชุฑ
```

#### ุทูู ูพุงุณุฎ AI:
```typescript
// app/api/voice-assistant/ai/route.ts
max_tokens: 800 // ุงูุฒุงุด ุจู 1000 ุจุฑุง ูพุงุณุฎโูุง ุฎู ุทููุงู
```

#### Timeout TTS:
```typescript
// app/api/voice-assistant/tts/route.ts
const timeoutDuration = Math.max(45000, processedText.length * 100);
// ุชุบุฑ ุถุฑุจ 100 ุจู 150 ุจุฑุง timeout ุจุดุชุฑ
```

---

## ๐ ุนุจโุงุจ

### ูุดฺฉู: ูพุงุณุฎโูุง ูููุฒ ฺฉูุชุงู ูุณุชูุฏ

**ุฑุงูโุญู:**
1. ุจุฑุฑุณ ฺฉูุฏ AI API key ุตุญุญ ุงุณุช
2. ูุฏู Claude 3 Haiku ุงุณุชูุงุฏู ูโุดูุฏ
3. max_tokens ุจู 800 ุชุบุฑ ุงูุชู

### ูุดฺฉู: ุตุฏุง ูพุฎุด ููโุดูุฏ

**ุฑุงูโุญู:**
1. ุจุฑุฑุณ Console ุจุฑุง ูุงฺฏโูุง ุฎุทุง
2. ุจุฑุฑุณ ุงุชุตุงู ุจู TTS API
3. ุชุณุช ุจุง ูุชู ฺฉูุชุงูโุชุฑ
4. ุจุฑุฑุณ CORS headers

### ูุดฺฉู: ุตุฏุง ุจุง ุชุงุฎุฑ ูพุฎุด ูโุดูุฏ

**ุฑุงูโุญู:**
1. ุงู ุทุจุน ุงุณุช ุจุฑุง ูุชูโูุง ุทููุงู
2. TTS API ุฒูุงู ุจุดุชุฑ ูุงุฒ ุฏุงุฑุฏ
3. preload='auto' ฺฉูฺฉ ูโฺฉูุฏ

---

## ๐ ุจูุจูุฏูุง ุขูุฏู (ูพุดููุงุฏ)

### 1. Cache ุตุฏุงูุง:
```typescript
// ุฐุฎุฑู ุตุฏุงูุง ุชููุฏ ุดุฏู
const audioCache = new Map<string, string>();
```

### 2. Streaming TTS:
```typescript
// ุฏุฑุงูุช ู ูพุฎุด ููุฒูุงู
// ูุงุฒ ุจู ุชุบุฑ ุฏุฑ TTS API
```

### 3. Offline Mode:
```typescript
// ุฐุฎุฑู ุตุฏุงูุง ุฑุงุฌ
// ุงุณุชูุงุฏู ุงุฒ Service Worker
```

### 4. Quality Selection:
```typescript
// ุงูุชุฎุงุจ ฺฉูุช ุตุฏุง
speaker: "3", // high quality
speaker: "1", // fast
```

---

## โ ฺฺฉโูุณุช ุชุณุช

- [ ] ูพุงุณุฎโูุง ุทููุงูโุชุฑ ุดุฏูโุงูุฏ (4-6 ุฌููู)
- [ ] ุฌุฒุฆุงุช ุจุดุชุฑ ุงุฑุงุฆู ูโุดูุฏ
- [ ] ุตุฏุง ุจุง ููููุช ูพุฎุด ูโุดูุฏ
- [ ] ุฏุฑ ุตูุฑุช ุฎุทุงุ 3 ุจุงุฑ ุชูุงุด ูโุดูุฏ
- [ ] ูุชู ูพุงุณุฎ ุฏุฑ ุตูุฑุช ุฎุทุง ุตุฏุง ููุงุด ุฏุงุฏู ูโุดูุฏ
- [ ] ูุงฺฏโูุง ููุฏ ุฏุฑ Console ููุงุด ุฏุงุฏู ูโุดููุฏ
- [ ] timeout ุจุฑุง ูุชูโูุง ุทููุงู ฺฉุงู ุงุณุช
- [ ] ุชุฌุฑุจู ฺฉุงุฑุจุฑ ุจูุชุฑ ุดุฏู

---

**ุชุงุฑุฎ ุจูุจูุฏ:** $(date)
**ูุณุฎู:** 2.0
**ูุถุนุช:** โ Ready for Testing
