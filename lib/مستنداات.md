# راهنمای تولید PDF و خروجی‌ها در پروژه

این مستند منطق تولید PDF و دانلود فایل‌ها در پروژه را توضیح می‌دهد.

---

## ساختار کلی

پروژه از دو روش برای تولید PDF استفاده می‌کند:

1. **Puppeteer** - برای کارنامه‌های دانش‌آموزان (با پشتیبانی کامل فارسی از طریق HTML)
2. **pdf-lib** - برای گزارش‌های پودمانی (سبک‌تر، بدون نیاز به مرورگر)

---

## API های موجود

### 1. کارنامه دانش‌آموز (PDF)
**مسیر:** `GET /api/students/[id]/pdf`

**فایل:** `src/app/api/students/[id]/pdf/route.ts`

```typescript
// دریافت اطلاعات دانش‌آموز با نمرات
const student = await prisma.student.findUnique({
  where: { id: studentId },
  include: {
    class: { include: { major: true, grade: true } },
    scores: { include: { subject: true } }
  }
})

// تولید PDF با Puppeteer
const pdfBuffer = await PDFService.generateReportCardPDF(
  student, scores, gpa, classRank
)

// بازگشت فایل PDF
return new NextResponse(pdfBuffer, {
  headers: {
    'Content-Type': 'application/pdf',
    'Content-Disposition': `attachment; filename="${filename}"`
  }
})
```

---

### 2. گزارش پودمانی (PDF)
**مسیر:** `GET /api/students/[id]/module-pdf`

**فایل:** `src/app/api/students/[id]/module-pdf/route.ts`

```typescript
// دریافت درس‌ها و پودمان‌ها
const subjects = await prisma.subject.findMany({
  where: { grade_id: student.class.grade_id },
  include: {
    modules: {
      orderBy: { module_number: 'asc' },
      include: {
        moduleScores: { where: { student_id: studentId } }
      }
    }
  }
})

// تولید PDF با pdf-lib
const pdfBuffer = await PDFLibService.generateModuleReportPDF(reportData)
```

---

### 3. کارنامه کل کلاس (PDF)
**مسیر:** `GET /api/classes/[id]/report-cards`

**فایل:** `src/app/api/classes/[id]/report-cards/route.ts`

```typescript
// دریافت همه دانش‌آموزان کلاس
const students = await db.student.findMany({
  where: { class_id: classId },
  include: { class: { include: { major: true, grade: true } } }
})

// تولید PDF با 2 کارنامه در هر صفحه
const pdfBuffer = await PDFService.generateClassReportCardsPDF(studentsWithRank)
```

---

### 4. خروجی Excel
**مسیر:** `GET /api/export/excel?classId=X`

**فایل:** `src/app/api/export/excel/route.ts`

```typescript
// تولید فایل Excel
const buffer = ExcelService.generateExcelExport(students)

return new NextResponse(buffer, {
  headers: {
    'Content-Type': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
    'Content-Disposition': `attachment; filename="students_${classId}.xlsx"`
  }
})
```

---

## سرویس‌های PDF

### PDFService (Puppeteer)
**فایل:** `src/lib/services/pdf.service.ts`

این سرویس از Puppeteer برای تولید PDF با پشتیبانی کامل فارسی استفاده می‌کند.

#### متدهای اصلی:

```typescript
// تولید کارنامه یک دانش‌آموز
static async generateReportCardPDF(
  student: StudentDetail,
  scores: ScoreDetail[],
  gpa: number,
  classRank?: number
): Promise<Buffer>

// تولید کارنامه کل کلاس (2 در هر صفحه)
static async generateClassReportCardsPDF(
  studentsData: Array<{
    student: StudentDetail
    scores: ScoreDetail[]
    gpa: number
    classRank?: number
  }>
): Promise<Buffer>
```

#### نحوه کار:
1. ایجاد HTML با فونت فارسی (Vazirmatn)
2. باز کردن مرورگر Puppeteer
3. رندر HTML در صفحه
4. تبدیل به PDF

```typescript
private static async generatePDFFromHTML(htmlContent: string): Promise<Buffer> {
  const browser = await this.initBrowser()
  const page = await browser.newPage()
  await page.setContent(htmlContent, { waitUntil: 'networkidle0' })
  const pdfBuffer = await page.pdf({
    format: 'A4',
    margin: { top: '20mm', right: '15mm', bottom: '20mm', left: '15mm' },
    printBackground: true
  })
  return pdfBuffer
}
```

---

### PDFLibService (pdf-lib)
**فایل:** `src/lib/services/pdflib-service.ts`

این سرویس از کتابخانه pdf-lib برای تولید PDF سبک‌تر استفاده می‌کند.

```typescript
static async generateModuleReportPDF(reportData: ModuleReportData): Promise<Buffer> {
  const pdfDoc = await PDFDocument.create()
  const page = pdfDoc.addPage([595, 842]) // A4 size
  const font = await pdfDoc.embedFont(StandardFonts.Helvetica)
  
  // رسم محتوا
  page.drawText('گزارش پیشرفت تحصیلی', {
    x: width / 2 - 80,
    y: yPos,
    size: 16,
    font: boldFont
  })
  
  const pdfBytes = await pdfDoc.save()
  return Buffer.from(pdfBytes)
}
```

---

## سرویس Excel
**فایل:** `src/lib/services/excel.service.ts`

```typescript
// پارس فایل Excel
static parseExcelFile(file: Buffer): ExcelParseResult {
  const workbook = XLSX.read(file, { type: 'buffer' })
  const worksheet = workbook.Sheets[workbook.SheetNames[0]]
  return XLSX.utils.sheet_to_json(worksheet)
}

// تولید فایل Excel
static generateExcelExport(students: StudentData[]): Buffer {
  const worksheet = XLSX.utils.json_to_sheet(exportData)
  const workbook = XLSX.utils.book_new()
  XLSX.utils.book_append_sheet(workbook, worksheet, 'Students')
  return XLSX.write(workbook, { bookType: 'xlsx', type: 'buffer' })
}
```

---

## کامپوننت‌های Frontend

### ModuleReportViewer
**فایل:** `src/components/ui/ModuleReportViewer.tsx`

```typescript
// دریافت داده‌های گزارش
const fetchReportData = async () => {
  const response = await fetch(`/api/students/${studentId}/module-report`)
  const data = await response.json()
  setReportData(data)
}

// دانلود PDF
const downloadPDF = async () => {
  const response = await fetch(`/api/students/${studentId}/module-pdf`)
  const blob = await response.blob()
  
  // ایجاد لینک دانلود
  const url = window.URL.createObjectURL(blob)
  const a = document.createElement('a')
  a.href = url
  a.download = `module-report-${studentId}.pdf`
  a.click()
  window.URL.revokeObjectURL(url)
}
```

### صفحه دانش‌آموز
**فایل:** `src/app/students/[studentId]/page.tsx`

```typescript
// دانلود کارنامه PDF
const handleDownloadPDF = async () => {
  const response = await fetch(`/api/students/${studentId}/pdf`)
  const blob = await response.blob()
  
  const url = window.URL.createObjectURL(blob)
  const link = document.createElement('a')
  link.href = url
  link.download = `report-card-${student?.full_name}-${studentId}.pdf`
  link.click()
  window.URL.revokeObjectURL(url)
}
```

---

## محاسبه نتیجه پودمان‌ها

```typescript
// محاسبه میانگین نمرات
const validScores = modules.filter(m => m.score !== null).map(m => m.score!)
const averageScore = validScores.reduce((sum, score) => sum + score, 0) / validScores.length

// تعیین نتیجه بر اساس میانگین
let result = 'ارزیابی نشده'
if (averageScore >= 17) {
  result = `عالی (${averageScore.toFixed(1)})`
  resultClass = 'excellent'
} else if (averageScore >= 14) {
  result = `خوب (${averageScore.toFixed(1)})`
  resultClass = 'good'
} else if (averageScore >= 12) {
  result = `قابل قبول (${averageScore.toFixed(1)})`
  resultClass = 'acceptable'
} else {
  result = `نیاز به تلاش بیشتر (${averageScore.toFixed(1)})`
  resultClass = 'needs-work'
}
```

---

## محاسبه معدل (GPA)

**فایل:** `src/lib/gpa.ts`

```typescript
// محاسبه معدل وزن‌دار
const totalWeighted = scores.reduce((sum, s) => {
  return sum + (s.score * s.subject.coefficient)
}, 0)

const totalCoefficient = scores.reduce((sum, s) => {
  return sum + s.subject.coefficient
}, 0)

const gpa = totalWeighted / totalCoefficient
```

---

## وابستگی‌ها

```json
{
  "puppeteer": "برای تولید PDF با HTML",
  "pdf-lib": "برای تولید PDF سبک",
  "xlsx": "برای خواندن و نوشتن Excel"
}
```

---

## نکات مهم

1. **فونت فارسی:** در Puppeteer از فونت Vazirmatn از CDN استفاده می‌شود
2. **مسیر Chrome:** در سرویس PDF، مسیر Chrome بر اساس سیستم‌عامل تنظیم شده
3. **حافظه:** برای کلاس‌های بزرگ، PDF به صورت 2 کارنامه در هر صفحه تولید می‌شود
4. **خطاها:** همه API ها از `withErrorHandler` برای مدیریت خطا استفاده می‌کنند
