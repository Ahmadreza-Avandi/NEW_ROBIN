<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ú©Ø´ Ùˆ ØªØ³Øª Tenant Filtering</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 800px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1 {
            color: #667eea;
            margin-bottom: 30px;
            text-align: center;
            font-size: 2em;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-right: 4px solid #667eea;
        }
        
        .section h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin: 5px;
            font-weight: bold;
        }
        
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .button:active {
            transform: translateY(0);
        }
        
        .status {
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            font-weight: bold;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .log {
            background: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
            direction: ltr;
            text-align: left;
        }
        
        .log-entry {
            margin-bottom: 8px;
            padding: 5px;
            border-radius: 3px;
        }
        
        .log-entry.success {
            color: #48bb78;
        }
        
        .log-entry.error {
            color: #f56565;
        }
        
        .log-entry.warning {
            color: #ed8936;
        }
        
        .log-entry.info {
            color: #4299e1;
        }
        
        ul {
            margin-right: 20px;
            margin-top: 10px;
        }
        
        li {
            margin-bottom: 8px;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ Ø§Ø¨Ø²Ø§Ø± Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ Ùˆ ØªØ³Øª Tenant Filtering</h1>
        
        <div class="section">
            <h2>ğŸ“‹ Ù…Ø±Ø­Ù„Ù‡ 1: Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ú©Ø´ Ùˆ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§</h2>
            <p>Ø§ÛŒÙ† Ø¯Ú©Ù…Ù‡ ØªÙ…Ø§Ù… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡ Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø± Ø±Ùˆ Ù¾Ø§Ú© Ù…ÛŒÚ©Ù†Ù‡:</p>
            <ul>
                <li>Local Storage</li>
                <li>Session Storage</li>
                <li>Cookies</li>
                <li>Cache Storage</li>
            </ul>
            <button class="button" onclick="clearAllCache()">ğŸ—‘ï¸ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù‡Ù…Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§</button>
            <div id="clearStatus"></div>
        </div>
        
        <div class="section">
            <h2>ğŸ§ª Ù…Ø±Ø­Ù„Ù‡ 2: ØªØ³Øª API Ù‡Ø§</h2>
            <p>Ø¨Ø¹Ø¯ Ø§Ø² Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ú©Ø´ØŒ Ø§ÛŒÙ† Ø¯Ú©Ù…Ù‡ Ø±Ùˆ Ø¨Ø²Ù† ØªØ§ API Ù‡Ø§ ØªØ³Øª Ø¨Ø´Ù†:</p>
            <button class="button" onclick="testAPIs()">ğŸ” ØªØ³Øª API Ù‡Ø§ÛŒ Tenant</button>
            <div id="testStatus"></div>
            <div id="testLog" class="log" style="display: none;"></div>
        </div>
        
        <div class="section">
            <h2>ğŸŒ Ù…Ø±Ø­Ù„Ù‡ 3: Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</h2>
            <p>Ø¨Ø¹Ø¯ Ø§Ø² ØªØ³Øª Ù…ÙˆÙÙ‚ØŒ Ø¨Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø¨Ø±Ú¯Ø±Ø¯:</p>
            <button class="button" onclick="goToDashboard()">â¡ï¸ Ø±ÙØªÙ† Ø¨Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</button>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('testLog');
            logDiv.style.display = 'block';
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const timestamp = new Date().toLocaleTimeString('fa-IR');
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        async function clearAllCache() {
            const statusDiv = document.getElementById('clearStatus');
            statusDiv.innerHTML = '<div class="status info">Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†...</div>';
            
            try {
                // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Local Storage
                localStorage.clear();
                
                // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Session Storage
                sessionStorage.clear();
                
                // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Cookies
                document.cookie.split(";").forEach(function(c) { 
                    document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
                });
                
                // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Cache Storage
                if ('caches' in window) {
                    const cacheNames = await caches.keys();
                    await Promise.all(cacheNames.map(name => caches.delete(name)));
                }
                
                statusDiv.innerHTML = '<div class="status success">âœ… Ù‡Ù…Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù¾Ø§Ú© Ø´Ø¯Ù†Ø¯!</div>';
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">âŒ Ø®Ø·Ø§: ${error.message}</div>`;
            }
        }

        async function testAPIs() {
            const statusDiv = document.getElementById('testStatus');
            const logDiv = document.getElementById('testLog');
            logDiv.innerHTML = '';
            logDiv.style.display = 'block';
            
            statusDiv.innerHTML = '<div class="status info">Ø¯Ø± Ø­Ø§Ù„ ØªØ³Øª...</div>';
            
            try {
                log('ğŸ” Ø´Ø±ÙˆØ¹ Ù„Ø§Ú¯ÛŒÙ† Ø¨Ø§ tenant rabin...', 'info');
                
                // Ù„Ø§Ú¯ÛŒÙ†
                const loginResponse = await fetch('/api/tenant/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Tenant-Key': 'rabin'
                    },
                    body: JSON.stringify({
                        email: 'Robintejarat@gmail.com',
                        password: 'admin123',
                        tenant_key: 'rabin'
                    })
                });
                
                const loginData = await loginResponse.json();
                
                if (!loginData.success) {
                    throw new Error('Ù„Ø§Ú¯ÛŒÙ† Ù†Ø§Ù…ÙˆÙÙ‚: ' + loginData.message);
                }
                
                log('âœ… Ù„Ø§Ú¯ÛŒÙ† Ù…ÙˆÙÙ‚', 'success');
                const token = loginData.token;
                
                // ØªØ³Øª Activities
                log('ğŸ¯ ØªØ³Øª Activities API...', 'info');
                const activitiesResponse = await fetch('/api/tenant/activities', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'X-Tenant-Key': 'rabin',
                        'Content-Type': 'application/json'
                    }
                });
                
                const activitiesData = await activitiesResponse.json();
                
                if (!activitiesData.success) {
                    throw new Error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª ÙØ¹Ø§Ù„ÛŒØªâ€ŒÙ‡Ø§: ' + activitiesData.message);
                }
                
                const activities = activitiesData.data || [];
                log(`âœ… Ø¯Ø±ÛŒØ§ÙØª ${activities.length} ÙØ¹Ø§Ù„ÛŒØª`, 'success');
                
                // Ø¨Ø±Ø±Ø³ÛŒ tenant_key
                const wrongTenant = activities.filter(a => a.tenant_key && a.tenant_key !== 'rabin');
                
                if (wrongTenant.length > 0) {
                    log(`âŒ ${wrongTenant.length} ÙØ¹Ø§Ù„ÛŒØª Ø§Ø² tenant Ø¯ÛŒÚ¯Ø± ÛŒØ§ÙØª Ø´Ø¯!`, 'error');
                    wrongTenant.slice(0, 3).forEach(a => {
                        log(`   - ${a.title} (tenant: ${a.tenant_key})`, 'error');
                    });
                    statusDiv.innerHTML = '<div class="status error">âŒ Ù…Ø´Ú©Ù„ Tenant Filtering Ù‡Ù†ÙˆØ² ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯!</div>';
                } else {
                    log('âœ… Ù‡Ù…Ù‡ ÙØ¹Ø§Ù„ÛŒØªâ€ŒÙ‡Ø§ Ù…ØªØ¹Ù„Ù‚ Ø¨Ù‡ tenant rabin Ù‡Ø³ØªÙ†Ø¯', 'success');
                    
                    // ØªØ³Øª Products
                    log('ğŸ“¦ ØªØ³Øª Products API...', 'info');
                    const productsResponse = await fetch('/api/tenant/products', {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'X-Tenant-Key': 'rabin'
                        }
                    });
                    const productsData = await productsResponse.json();
                    const products = productsData.data || [];
                    log(`âœ… Ø¯Ø±ÛŒØ§ÙØª ${products.length} Ù…Ø­ØµÙˆÙ„`, 'success');
                    
                    // ØªØ³Øª Sales
                    log('ğŸ’° ØªØ³Øª Sales API...', 'info');
                    const salesResponse = await fetch('/api/tenant/sales', {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'X-Tenant-Key': 'rabin'
                        }
                    });
                    const salesData = await salesResponse.json();
                    const sales = salesData.sales || salesData.data || [];
                    log(`âœ… Ø¯Ø±ÛŒØ§ÙØª ${sales.length} ÙØ±ÙˆØ´`, 'success');
                    
                    // ØªØ³Øª Customers
                    log('ğŸ‘¥ ØªØ³Øª Customers API...', 'info');
                    const customersResponse = await fetch('/api/tenant/customers', {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'X-Tenant-Key': 'rabin'
                        }
                    });
                    const customersData = await customersResponse.json();
                    const customers = customersData.customers || customersData.data || [];
                    log(`âœ… Ø¯Ø±ÛŒØ§ÙØª ${customers.length} Ù…Ø´ØªØ±ÛŒ`, 'success');
                    
                    log('ğŸ‰ Ù‡Ù…Ù‡ ØªØ³Øªâ€ŒÙ‡Ø§ Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯Ù†Ø¯!', 'success');
                    statusDiv.innerHTML = '<div class="status success">âœ… Ù‡Ù…Ù‡ API Ù‡Ø§ Ø¯Ø±Ø³Øª Ú©Ø§Ø± Ù…ÛŒÚ©Ù†Ù†! Ù…ÛŒØªÙˆÙ†ÛŒ Ø¨Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø¨Ø±Ú¯Ø±Ø¯ÛŒ.</div>';
                }
                
            } catch (error) {
                log(`âŒ Ø®Ø·Ø§: ${error.message}`, 'error');
                statusDiv.innerHTML = `<div class="status error">âŒ Ø®Ø·Ø§: ${error.message}</div>`;
            }
        }

        function goToDashboard() {
            window.location.href = '/rabin/dashboard/activities';
        }
    </script>
</body>
</html>
