# قابلیت حافظه دستیار صوتی رابین

## ✅ چیزهایی که پیاده‌سازی شده

### 1. حافظه گفتگو (Conversation Memory)
دستیار صوتی رابین حالا می‌تونه حرف‌های قبلی رو به یاد بیاره:

- **ذخیره در مرورگر**: تاریخچه گفتگوها در `localStorage` ذخیره می‌شه
- **ارسال به AI**: تمام گفتگوهای قبلی به OpenRouter AI ارسال می‌شن
- **درک متنی**: AI می‌تونه به گفتگوهای قبلی رجوع کنه

### 2. مثال‌های استفاده

```
کاربر: "احمدرضا آوندی رو می‌شناسی؟"
رابین: "بله، احمدرضا آوندی یکی از همکاران ماست با نقش agent"

کاربر: "چه کارهایی انجام داده؟"
رابین: [به احمدرضا آوندی از گفتگوی قبلی اشاره می‌کنه]

کاربر: "او کیست؟"
رابین: [می‌فهمه که منظور احمدرضا آوندی از گفتگوی قبلیه]
```

### 3. ذخیره‌سازی تاریخچه

- **مکان**: `localStorage` با کلید `voice-history-{tenant_key}`
- **فرمت**: آرایه‌ای از پیام‌ها شامل:
  ```typescript
  {
    user: string,      // پیام کاربر
    robin: string,     // پاسخ رابین
    timestamp: Date    // زمان گفتگو
  }
  ```
- **بارگذاری خودکار**: با باز کردن صفحه، تاریخچه قبلی بارگذاری می‌شه
- **پاک کردن**: دکمه "پاک کردن" در پنجره تاریخچه

### 4. نحوه کار در Backend

در `app/api/voice-assistant/ai/route.ts`:

```typescript
// دریافت تاریخچه از frontend
const { userMessage, history } = await req.json();

// ساخت پیام‌ها برای AI
const messages = [
  { role: 'system', content: systemMessage }
];

// اضافه کردن تاریخچه
history.forEach((h) => {
  messages.push({ role: 'user', content: h.user });
  messages.push({ role: 'assistant', content: h.robin });
});

// اضافه کردن پیام فعلی
messages.push({ role: 'user', content: userMessage });
```

### 5. قابلیت‌های حافظه

✅ **یادآوری اسامی**: اگر کاربر از شخصی نام برد، رابین یادش می‌مونه
✅ **درک ضمایر**: "او"، "آن شخص"، "همان مشتری" رو می‌فهمه
✅ **ادامه گفتگو**: "بیشتر بگو"، "چطور؟"، "چرا؟" رو به موضوع قبلی ربط می‌ده
✅ **ذخیره دائمی**: با رفرش صفحه تاریخچه پاک نمی‌شه
✅ **جداسازی tenant**: هر tenant تاریخچه جداگانه داره

## 🧪 تست کردن

1. برو به: `http://localhost:3000/rabin/dashboard/voice-assistant`
2. بگو: "احمدرضا آوندی رو می‌شناسی؟"
3. بعد بگو: "او چه کارهایی انجام داده؟"
4. رابین باید بفهمه که "او" یعنی احمدرضا آوندی

## 📊 لاگ‌ها

در console مرورگر:
- `💾 History saved: X messages` - ذخیره تاریخچه
- `🗑️ History cleared from storage` - پاک کردن تاریخچه

در console سرور:
- `📚 Adding X previous conversations to context` - اضافه کردن تاریخچه به AI
- `[1] User: ...` - پیام کاربر از تاریخچه
- `[1] Robin: ...` - پاسخ رابین از تاریخچه

## 🔧 تنظیمات

برای محدود کردن تعداد پیام‌های ذخیره شده، می‌تونی در `page.tsx` یه محدودیت اضافه کنی:

```typescript
// فقط 20 گفتگوی آخر رو نگه دار
if (state.history.length > 20) {
  const limitedHistory = state.history.slice(-20);
  localStorage.setItem(`voice-history-${tenantKey}`, JSON.stringify(limitedHistory));
}
```

## 🎯 نکات مهم

1. **حریم خصوصی**: تاریخچه فقط در مرورگر کاربر ذخیره می‌شه
2. **امنیت**: هر tenant تاریخچه جداگانه داره
3. **عملکرد**: تاریخچه طولانی ممکنه هزینه API رو زیاد کنه
4. **پاک‌سازی**: کاربر می‌تونه تاریخچه رو پاک کنه
